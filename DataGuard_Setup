#!/bin/bash

# Set Oracle environment variables
export ORACLE_HOME=/path/to/oracle_home
export PATH=$ORACLE_HOME/bin:$PATH

# Set Oracle connection details
ORACLE_USER="your_username"
ORACLE_PASSWORD="your_password"
ORACLE_SID_PRIMARY="your_primary_sid"
ORACLE_SID_STANDBY="your_standby_sid"

# Primary database setup
sqlplus -s ${ORACLE_USER}/${ORACLE_PASSWORD}@${ORACLE_SID_PRIMARY} <<EOF
ALTER DATABASE FORCE LOGGING;
ALTER SYSTEM SET LOG_ARCHIVE_CONFIG='DG_CONFIG=(primary_db,standby_db)';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_1='LOCATION=/archive/valid_path VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=primary_db';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_2='SERVICE=standby_db LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=standby_db';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_1=ENABLE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_2=ENABLE;
ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE;
ALTER SYSTEM SET FAL_SERVER=standby_db;
ALTER SYSTEM SET FAL_CLIENT=primary_db;
ALTER SYSTEM SET DB_FILE_NAME_CONVERT='/standby/dir','/primary/dir';
ALTER SYSTEM SET LOG_FILE_NAME_CONVERT='/standby/dir','/primary/dir';
ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT=AUTO;
EXIT;
EOF

# Backup primary database
rman target / <<EOF
BACKUP DATABASE PLUS ARCHIVELOG;
EXIT;
EOF

# Transfer backup to standby server (adjust path and user as necessary)
scp /path/to/backup/files user@standby_server:/path/to/standby/backup/

# Standby database setup (run this on the standby server)
sqlplus -s ${ORACLE_USER}/${ORACLE_PASSWORD}@${ORACLE_SID_STANDBY} <<EOF
STARTUP NOMOUNT;
EXIT;
EOF

rman target / <<EOF
RESTORE CONTROLFILE FROM '/path/to/backup/controlfile';
RESTORE DATABASE;
RECOVER DATABASE;
EXIT;
EOF

sqlplus -s ${ORACLE_USER}/${ORACLE_PASSWORD}@${ORACLE_SID_STANDBY} <<EOF
ALTER SYSTEM SET DB_UNIQUE_NAME=standby_db;
ALTER SYSTEM SET LOG_ARCHIVE_CONFIG='DG_CONFIG=(primary_db,standby_db)';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_1='LOCATION=/archive/valid_path VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=standby_db';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_2='SERVICE=primary_db LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,STANDBY_ROLE) DB_UNIQUE_NAME=primary_db';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_1=ENABLE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_2=ENABLE;
ALTER SYSTEM SET REMOTE_LOGIN_PASSWORDFILE=EXCLUSIVE;
ALTER SYSTEM SET FAL_SERVER=primary_db;
ALTER SYSTEM SET FAL_CLIENT=standby_db;
ALTER SYSTEM SET DB_FILE_NAME_CONVERT='/primary/dir','/standby/dir';
ALTER SYSTEM SET LOG_FILE_NAME_CONVERT='/primary/dir','/standby/dir';
ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT=AUTO;
STARTUP MOUNT;
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT FROM SESSION;
EXIT;
EOF
